// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── ENUMS ───────────────────────────────────────────────

enum UserRole {
  SYSADMIN
  LOTEADORA
  CORRETOR
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
}

enum ReservationFeeType {
  FIXED
  PERCENTAGE
}

enum MapElementType {
  LOT
  ROAD
  ROUNDABOUT
  LAKE
  GREEN
  LABEL
  PATH
  POLYGON
}

enum GeometryType {
  POLYGON
  POLYLINE
  CIRCLE
  RECT
}

enum LotStatus {
  AVAILABLE
  RESERVED
  SOLD
}

enum SlopeType {
  FLAT
  UPHILL
  DOWNHILL
}

enum MediaType {
  PHOTO
  VIDEO
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  NEGOTIATING
  RESERVATION
  UNDER_REVIEW
  WAITING_DOCS
  WAITING_PAYMENT
  WON
  LOST
  CANCELLED
  ABANDONED
  REVERSED
}

enum LeadPaymentType {
  RESERVATION_FEE
  ENTRY
  INSTALLMENT
  INTERMEDIARY
}

enum LeadPaymentStatus {
  PENDING
  PAID
  OVERDUE
  REVERSED
}

enum SchedulingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentProvider {
  STRIPE
  MERCADO_PAGO
  PAGSEGURO
  ASAAS
  PAGAR_ME
  PIX_DIRECT // Manual bank transfer / key
}

enum PlantHotspotType {
  LOTE
  PORTARIA
  QUADRA
  AREA_COMUM
  OUTRO
}

enum PlantHotspotLinkType {
  LOTE_PAGE
  PROJECT_PAGE
  CUSTOM_URL
  NONE
}

// ─── CORE MODELS ────────────────────────────────────────

model Tenant {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  customDomain String?  @unique
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users         User[]
  projects      Project[]
  mapElements   MapElement[]
  lotDetails    LotDetails[]
  projectMedias ProjectMedia[]
  leads         Lead[]
  realtorLinks     RealtorLink[]
  plantMaps        PlantMap[]
  plantHotspots    PlantHotspot[]
  panoramas        Panorama[]
  panoramaBeacons  PanoramaBeacon[]
  trackingSessions TrackingSession[]
  campanhas         Campaign[]
  paymentGateways   PaymentConfig[]
  aiConfigs         AiConfig[]
  schedulings       Scheduling[]
}

model User {
  id           String   @id @default(cuid())
  tenantId     String?
  tenant       Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(CORRETOR)
  isActive     Boolean  @default(true)
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  realtorLink RealtorLink?
  campaigns   Campaign[]
  schedulings Scheduling[]

  @@index([tenantId])
}

model Project {
  id              String        @id @default(cuid())
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name            String
  slug            String        @unique
  customDomain    String?       @unique
  description     String?       @db.Text
  status          ProjectStatus @default(DRAFT)
  bannerImageUrl  String?
  mapData         Json?
  highlightsJson  Json?
  locationText    String?       @db.Text
  address         String?       @db.Text
  googleMapsUrl   String?       @db.Text
  showPaymentConditions Boolean @default(false)
  startingPrice   Decimal?      @db.Decimal(12, 2)
  maxInstallments Int?          @default(180)
  minDownPaymentPercent    Decimal?            @default(10) @db.Decimal(5, 2)
  minDownPaymentValue      Decimal?            @db.Decimal(12, 2)
  monthlyInterestRate      Decimal?            @default(0.9) @db.Decimal(5, 4)
  indexer                  String?             @default("IGP-M")
  allowIntermediary        Boolean             @default(false)
  financingDisclaimer      String?             @db.Text
  paymentConditionsSummary String? @db.Text
  youtubeVideoUrl  String?
  constructionStatus Json?
  reservationFeeType    ReservationFeeType @default(FIXED)
  reservationFeeValue   Decimal            @default(500) @db.Decimal(12, 2)
  reservationExpiryHours Int               @default(24)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  mapElements   MapElement[]
  lotDetails    LotDetails[]
  projectMedias ProjectMedia[]
  leads         Lead[]
  realtorLinks  RealtorLink[]
  plantMap      PlantMap?
  panoramas     Panorama[]
  trackingSessions TrackingSession[]
  campaigns        Campaign[]
  paymentGateways  PaymentConfig[] @relation("ProjectGateways")

  aiEnabled        Boolean       @default(false)
  aiConfigId       String?
  aiConfig         AiConfig?     @relation(fields: [aiConfigId], references: [id], onDelete: SetNull)
  schedulingConfig SchedulingConfig?
  schedulings      Scheduling[]

  @@index([tenantId])
  @@index([slug])
}

model MapElement {
  id           String         @id @default(cuid())
  tenantId     String
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type         MapElementType
  name         String?
  code         String?
  geometryType GeometryType
  geometryJson Json
  styleJson    Json?
  metaJson     Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  lotDetails LotDetails?
  leads      Lead[]

  @@index([tenantId, projectId, code])
  @@index([tenantId, projectId])
}

model LotDetails {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId      String
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  mapElementId   String    @unique
  mapElement     MapElement @relation(fields: [mapElementId], references: [id], onDelete: Cascade)
  version        Int        @default(0)
  status         LotStatus  @default(AVAILABLE)
  price          Decimal?   @db.Decimal(12, 2)
  areaM2         Float?
  frontage       Float?
  depth          Float?
  sideLeft       Float?
  sideRight      Float?
  slope          SlopeType  @default(FLAT)
  conditionsJson Json?
  sideMetricsJson Json?
  paymentConditions Json?
  panoramaUrl    String?
  notes          String?    @db.Text
  tags           String[]   @default([])
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  medias ProjectMedia[]

  @@index([tenantId, projectId])
  @@index([status])
}

model ProjectMedia {
  id           String      @id @default(cuid())
  tenantId     String
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  lotDetailsId String?
  lotDetails   LotDetails? @relation(fields: [lotDetailsId], references: [id], onDelete: SetNull)
  type         MediaType   @default(PHOTO)
  url          String
  caption      String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([tenantId, projectId])
  @@index([lotDetailsId])
}

model Lead {
  id            String     @id @default(cuid())
  tenantId      String
  tenant        Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId     String
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  mapElementId  String?
  mapElement    MapElement? @relation(fields: [mapElementId], references: [id], onDelete: SetNull)
  realtorLinkId String?
  realtorLink   RealtorLink? @relation(fields: [realtorLinkId], references: [id], onDelete: SetNull)
  sessionId     String?
  session       TrackingSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  name          String
  email         String?
  phone         String?
  version       Int        @default(0)
  
  // Registration data
  cpf           String?
  rg            String?
  birthDate     DateTime?
  maritalStatus String?
  occupation    String?
  address       String?
  addressCity   String?
  addressState  String?
  addressZip    String?

  message       String?    @db.Text
  source        String?
  status        LeadStatus @default(NEW)
  lastContactAt DateTime?
  reservedAt    DateTime?
  notes         String?    @db.Text
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Attribution data
  ftUtmSource   String?
  ftUtmMedium   String?
  ftUtmCampaign String?
  ftUtmContent  String?
  ftUtmTerm     String?
  
  ltUtmSource   String?
  ltUtmMedium   String?
  ltUtmCampaign String?
  ltUtmContent  String?
  ltUtmTerm     String?
  ltReferrer    String?
  isRecurrent   Boolean    @default(false)

  documents     LeadDocument[]
  payments      LeadPayment[]
  history       LeadHistory[]
  schedulings   Scheduling[]

  @@index([tenantId, projectId])
  @@index([status, createdAt])
  @@index([email])
  @@index([phone])
  @@index([cpf])
  @@index([sessionId])
  @@index([realtorLinkId])
  @@index([createdAt(sort: Desc)])
}

model LeadDocument {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  name        String
  url         String
  type        String
  uploadedBy  String
  createdAt   DateTime @default(now())

  @@index([leadId])
}

model LeadPayment {
  id          String            @id @default(cuid())
  leadId      String
  lead        Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type        LeadPaymentType
  status      LeadPaymentStatus @default(PENDING)
  amount      Decimal           @db.Decimal(12, 2)
  dueDate     DateTime
  paidDate    DateTime?
  receiptUrl  String?
  notes       String?           @db.Text
  
  // New payment gateway fields
  externalId  String?           // External transaction ID (Stripe, MP, etc.)
  paymentUrl  String?           // Checkout URL for the user
  provider    PaymentProvider?
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([leadId])
}

model LeadHistory {
  id          String      @id @default(cuid())
  leadId      String
  lead        Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  fromStatus  LeadStatus?
  toStatus    LeadStatus
  notes       String?     @db.Text
  createdBy   String
  createdAt   DateTime    @default(now())

  @@index([leadId])
}

model RealtorLink {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects    Project[]
  userId      String?   @unique
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  name        String
  phone       String?
  email       String?
  creci       String?
  photoUrl    String?
  code        String
  enabled     Boolean   @default(true)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  leads            Lead[]
  trackingSessions TrackingSession[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

// ─── PANORAMA 360 ───────────────────────────────────────

enum PanoramaProjection {
  FLAT
  EQUIRECTANGULAR
}

model Panorama {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title      String   @default("Vista Geral")
  projection PanoramaProjection @default(FLAT)
  published  Boolean  @default(false)
  sunPathAngleDeg     Float    @default(0)
  sunPathLabelEnabled Boolean  @default(true)
  showImplantation    Boolean  @default(false)
  implantationUrl     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  snapshots PanoramaSnapshot[]
  beacons   PanoramaBeacon[]

  @@index([tenantId])
  @@index([tenantId, projectId])
}

model PanoramaSnapshot {
  id          String   @id @default(cuid())
  panoramaId  String
  panorama    Panorama @relation(fields: [panoramaId], references: [id], onDelete: Cascade)
  imageUrl    String
  imageWidth  Int?
  imageHeight Int?
  label       String
  date        DateTime?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([panoramaId])
}

model PanoramaBeacon {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  panoramaId  String
  panorama    Panorama @relation(fields: [panoramaId], references: [id], onDelete: Cascade)
  title       String
  description String?  @db.Text
  x           Float
  y           Float
  style       String   @default("default")
  visible     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([panoramaId])
  @@index([tenantId])
}

// ─── PLANT MAP (Planta Interativa) ──────────────────────

model PlantMap {
  id                  String   @id @default(cuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId           String   @unique
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  imageUrl            String
  imageWidth          Int?
  imageHeight         Int?
  sunPathEnabled      Boolean  @default(false)
  sunPathAngleDeg     Float    @default(0)
  sunPathLabelEnabled Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  hotspots PlantHotspot[]

  @@index([tenantId])
}

model PlantHotspot {
  id           String               @id @default(cuid())
  tenantId     String
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plantMapId   String
  plantMap     PlantMap             @relation(fields: [plantMapId], references: [id], onDelete: Cascade)
  type         PlantHotspotType     @default(OUTRO)
  title        String
  description  String?              @db.Text
  x            Float
  y            Float
  label        String?
  labelEnabled Boolean              @default(true)
  labelOffsetX Float                @default(0)
  labelOffsetY Float                @default(-24)
  linkType     PlantHotspotLinkType @default(NONE)
  linkId       String?
  linkUrl      String?
  loteStatus   LotStatus?
  metaJson     Json?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([plantMapId])
  @@index([tenantId])
}

// ─── ANALYTICS & TRACKING ────────────────────────────────

model TrackingSession {
  id           String   @id @default(cuid())
  tenantId     String?
  tenant       Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  realtorLinkId String?
  realtorLink   RealtorLink? @relation(fields: [realtorLinkId], references: [id], onDelete: SetNull)
  userId       String?
  
  // Basic info
  ip           String?
  ipHash       String?
  userAgent    String?
  deviceType   String?
  landingPage  String?
  
  // Dates
  firstSeenAt  DateTime @default(now())
  lastSeenAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // First Touch Attribution (Immutable)
  ftUtmSource  String?
  ftUtmMedium  String?
  ftUtmCampaign String?
  ftUtmContent String?
  ftUtmTerm    String?
  ftReferrer   String?
  
  // Last Touch Attribution (Mutable)
  ltUtmSource  String?
  ltUtmMedium  String?
  ltUtmCampaign String?
  ltUtmContent String?
  ltUtmTerm    String?
  ltReferrer   String?

  // Current Attribution State (for legacy compatibility and convenient access)
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  utmContent   String?
  utmTerm      String?
  referrer     String?

  // Realtor Attribution (30-day window)
  lastRealtorAt DateTime?

  events TrackingEvent[]
  leads  Lead[]

  @@index([tenantId, projectId])
  @@index([projectId, lastSeenAt])
  @@index([tenantId, createdAt])
  @@index([createdAt])
  @@index([lastSeenAt])
}

model TrackingEvent {
  id        String          @id @default(cuid())
  sessionId String
  session   TrackingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  type      String // PAGE_VIEW, CLICK, TOOL_USE, FORM_SUBMIT, etc.
  category  String? // LOT, REALTOR_LINK, MAP_TOOL, etc.
  action    String? // VIEW_DETAILS, OPEN_LINK, ZOOM, etc.
  label     String? // Lot A-12, Corretor Joao, etc.
  value     Float?
  metadata  Json?
  path      String?
  timestamp DateTime        @default(now())

  @@index([sessionId, timestamp])
  @@index([type, category, timestamp])
  @@index([timestamp])
  @@index([type, timestamp])
}

model Campaign {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId       String?
  creator      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  name         String
  utmSource    String
  utmMedium    String?
  utmCampaign  String
  utmContent   String?
  utmTerm      String?
  budget       Decimal? @db.Decimal(12, 2)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  investments CampaignInvestment[]

  @@index([tenantId])
  @@index([projectId])
}

model CampaignInvestment {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime @default(now())
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([campaignId])
}

model SystemSetting {
  id               String   @id @default(cuid())
  contactWhatsapp  String?
  contactEmail     String?
  leadFormEnabled  Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SystemLead {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  message   String?  @db.Text
  status    LeadStatus @default(NEW)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model PaymentConfig {
  id               String          @id @default(cuid())
  tenantId         String
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name             String          @default("Gateway Principal")
  provider         PaymentProvider @default(STRIPE)
  isActive         Boolean         @default(true)
  keysJson         Json?           // Stores publicKey, secretKey, accessToken, etc.
  webhookSecret    String?         // Common for most gateways
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  projects         Project[]       @relation("ProjectGateways")

  @@index([tenantId])
}

model AiConfig {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  provider     String   @default("openai") // e.g. openai, anthropic, google
  model        String   @default("gpt-4o") // e.g. gpt-4o, gpt-3.5-turbo, claude-3-haiku
  apiKey       String?
  systemPrompt String?  @db.Text
  temperature  Float?   @default(0.7)
  maxTokens    Int?     @default(1000)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  projects Project[]

  @@index([tenantId])
}

model SchedulingConfig {
  id                  String   @id @default(cuid())
  projectId           String   @unique
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  enabled             Boolean  @default(false)
  scheduleInterval    Int      @default(60) // minutes
  leadCaptureRequired Boolean  @default(true)
  availableDays       Json?    // ["MON", "TUE", ...]
  startTime           String   @default("08:00")
  endTime             String   @default("18:00")
  maxSimultaneous     Int      @default(1)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Scheduling {
  id          String           @id @default(cuid())
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  leadId      String?
  lead        Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  userId      String?
  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  scheduledAt DateTime
  status      SchedulingStatus @default(PENDING)
  notes       String?          @db.Text
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([tenantId, projectId])
  @@index([scheduledAt])
}
