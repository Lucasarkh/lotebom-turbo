# =============================================
# Lotio — Production Docker Compose
# Infraestrutura + Backend containerizado
# =============================================
# Uso:
#   docker compose -f docker-compose.prod.yml up -d
#
# Todas as credenciais vêm de variáveis de ambiente.
# Copie .env.production.example → .env e preencha.
# =============================================

services:

  # ── PostgreSQL ────────────────────────────────
  db:
    image: postgres:17-alpine
    container_name: lotio_db
    restart: always
    ports:
      - "${DB_PORT:-127.0.0.1:5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?Defina POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Defina POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-lotio}
      POSTGRES_INITDB_ARGS: "--data-checksums"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=768MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "log_min_duration_statement=1000"
      - "-c"
      - "log_statement=ddl"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G

  # ── Redis ─────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: lotio_redis
    restart: always
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:?Defina REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
    ports:
      - "${REDIS_PORT:-127.0.0.1:6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M

  # ── RabbitMQ ──────────────────────────────────
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: lotio_rabbitmq
    restart: unless-stopped
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:?Defina RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:?Defina RABBITMQ_PASS}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M

  # ── Backend (NestJS) ──────────────────────────
  backend:
    image: ghcr.io/${GHCR_OWNER:?Defina GHCR_OWNER}/lotio-backend:${BACKEND_TAG:-latest}
    container_name: lotio_backend
    restart: always
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-lotio}?schema=public
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:?Defina JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?Defina ENCRYPTION_KEY}
      MAIN_DOMAIN: ${MAIN_DOMAIN:-lotio.com.br}
      FRONTEND_URL: ${FRONTEND_URL:-https://app.lotio.com.br}
      # AWS / S3
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-lot-uploads}
      # SendPulse
      SENDPULSE_CLIENT_ID: ${SENDPULSE_CLIENT_ID:-}
      SENDPULSE_CLIENT_SECRET: ${SENDPULSE_CLIENT_SECRET:-}
      SENDPULSE_FROM_EMAIL: ${SENDPULSE_FROM_EMAIL:-}
      SENDPULSE_FROM_NAME: ${SENDPULSE_FROM_NAME:-Lotio}
      # Payments
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      MERCADOPAGO_ACCESS_TOKEN: ${MERCADOPAGO_ACCESS_TOKEN:-}
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app_network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ── Prometheus ────────────────────────────────
  prometheus:
    image: prom/prometheus
    container_name: lotio_prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus.prod.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - app_network
    deploy:
      resources:
        limits:
          memory: 256M

  # ── Grafana ───────────────────────────────────
  grafana:
    image: grafana/grafana
    container_name: lotio_grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-4000}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASS:?Defina GRAFANA_PASS}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:4000}
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - app_network
    deploy:
      resources:
        limits:
          memory: 256M

  # ── Postgres Exporter (opcional) ──────────────
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: lotio_pg_exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-lotio}?sslmode=disable"
    ports:
      - "${PG_EXPORTER_PORT:-9187}:9187"
    networks:
      - app_network
    depends_on:
      db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M

# ── Networks ──────────────────────────────────
networks:
  app_network:
    driver: bridge

# ── Volumes (dados persistentes) ─────────────
volumes:
  pgdata:
  redis_data:
  rabbitmq_data:
  prometheus_data:
  grafana_data:
